<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Full Mark | Ø§Ù„Ù…Ù†ØµØ©</title>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --main: #00e1ff; --bg: #02050a; --card: #0a0f18; --text: #fff; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Cairo', sans-serif; -webkit-user-select: none; user-select: none; }
        body { background: linear-gradient(135deg, #02050a 0%, #050a14 100%); color: var(--text); min-height: 100vh; overflow-x: hidden; }
        .container { max-width: 1200px; margin: 0 auto; padding: 15px; }
        header { display: flex; justify-content: space-between; align-items: center; background: rgba(10, 15, 24, 0.95); border-bottom: 2px solid var(--main); padding: 10px 20px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 0 25px rgba(0, 225, 255, 0.15); }
        .logo { font-size: 1.6rem; font-weight: 900; color: var(--main); text-shadow: 0 0 15px rgba(0, 225, 255, 0.7); }
        .icon-btn { width: 40px; height: 40px; border-radius: 50%; background: rgba(255,255,255,0.1); color: #fff; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .nav-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        #backBtn { display: none; background: transparent; color: var(--main); border: 2px solid var(--main); padding: 5px 20px; border-radius: 50px; font-weight: bold; }
        .grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; }
        @media(min-width: 768px) { .grid { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px; } }
        .card { background: var(--card); border: 1px solid rgba(0, 225, 255, 0.15); border-radius: 15px; overflow: hidden; cursor: pointer; transition: 0.3s; position: relative; }
        .card:active { transform: scale(0.97); border-color: var(--main); }
        .card img { width: 100%; height: 160px; object-fit: cover; }
        .card-title { padding: 10px; text-align: center; font-weight: bold; background: #0f121a; border-top: 1px solid #222; }
        .video-wrapper { background: #000; border-radius: 15px; overflow: hidden; border: 1px solid #333; margin-bottom: 15px; position: relative; }
        .video-header { padding: 10px; background: #111; color: var(--main); font-weight: bold; text-align: center; }
        .watermark { position: absolute; top: 20px; left: 20px; color: rgba(255,255,255,0.4); font-family: monospace; font-weight: bold; z-index: 99; pointer-events: none; animation: move 10s infinite alternate; }
        @keyframes move { 0% {top:10%; left:10%;} 100% {top:80%; left:80%;} }
    </style>
</head>
<body oncontextmenu="return false">

    <div class="container">
        <header>
            <div class="logo">FULL MARK</div>
            <div style="display:flex; gap:10px;">
                <div class="icon-btn" onclick="location.reload()"><i class="fas fa-sync"></i></div>
                <div class="icon-btn" style="color:red; border:1px solid red;" onclick="logout()"><i class="fas fa-power-off"></i></div>
            </div>
        </header>

        <div class="nav-bar">
            <h2 id="pageTitle">Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©</h2>
            <button id="backBtn" onclick="goBack()">ğŸ”™ Ø±Ø¬ÙˆØ¹</button>
        </div>
        
        <div id="gridArea" class="grid"></div>
        <div style="height: 50px;"></div>
    </div>

    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyBKY38XHjmC-iGqGrQio_YZ_i1iaIaE2Ds", authDomain: "full-mark-8d434.firebaseapp.com", projectId: "full-mark-8d434", storageBucket: "full-mark-8d434.firebasestorage.app", messagingSenderId: "802579483999", appId: "1:802579483999:web:cf73136ffbd75d5e0ebaea" };
        firebase.initializeApp(firebaseConfig); const db = firebase.firestore();

        // 1. Ø§Ù„Ø¯Ø§ØªØ§ Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù…Ø¯Ø±Ø³ÙŠÙ†)
        let ALL_DATA = [
            {
                name: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", img: "https://i.postimg.cc/L6xvnk5X/mn-awl-mn-tklm-allght-alÊ¿rbyt.jpg",
                teachers: [{ name: "Ø£. Ù…Ø­Ù…Ø¯ ØµÙ„Ø§Ø­", img: "https://files.coursatk.online/images/questions/abc2fcc42883dd1a9e93021922da73dc92ff4b40ec76.jpg", chapters: [] }, { name: "Ø£. Ø±Ø¶Ø§ Ø§Ù„ÙØ§Ø±ÙˆÙ‚", img: "https://i.postimg.cc/c4Pg965p/1723904748-y-CL9UA.png", chapters: [] }]
            },
            {
                name: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©", img: "https://i.postimg.cc/TwvBCjry/characteristics-of-a-prestigious-language-school-1-1020x642-1.jpg",
                teachers: [{ name: "Ø¹Ø¨Ù‚Ø±ÙŠ Ù„ØºØ©", img: "https://files.coursatk.online/images/content/cc3fbcdbba91a2ed893fa92228b089a50eeced1fa245.jpg", chapters: [{chapter_name:"Unit 7", videos:[{name:"Ù„Ø¹Ø¨Ø© ÙƒÙ„Ù…Ø§Øª", link:"https://river-3-345.rtbcdn.ru/hls-vod/oYl6bYGCWxjkkzOTjczQeQ/1770554251/1879/0x5000c500e53a27da/9d1a971b866f4bd081ea784b13680871.mp4.m3u8"}]}] }, { name: "Ø´Ø±ÙŠÙ Ø§Ù„Ù…ØµØ±ÙŠ", img: "https://i.postimg.cc/4nRGtCBW/loginbg.png", chapters: [] }]
            },
            {
                name: "Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡", img: "https://static.vecteezy.com/system/resources/previews/014/472/954/original/chemistry-logo-template-illustration-free-vector.jpg",
                teachers: [
                    { 
                        name: "Ø£. Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø¬ÙˆØ§Ø¯", img: "https://files.coursatk.online/images/questions/23b4ebea27532d1d05b2f7de5f26e63add3e4ca8ffcd.jpg", 
                        chapters: [
                            { chapter_name: "Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§Øª", videos: [{name:"Ø§Ù„ØªØ£Ø³ÙŠØ³", link:"https://river-5-533.rtbcdn.ru/hls-vod/iSmUdDzLxKk8Ln_4GDlIpQ/1770394615/3402/0x5000c500fa6e9016/dda8cd611e33417f84af22dfc71c0a91.mp4.m3u8"}] },
                            { chapter_name: "Ø§Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø£ÙˆÙ„", videos: [{name:"Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© 1", link:"https://river-3-301.rtbcdn.ru/hls-vod/bbMBvuDTTcLPLma86u5TfA/1770408256/2636/0x5000039ce868ef9d/a267d076ca524d73a4c80f7f69eb6689.mp4.m3u8"}] }
                        ] 
                    }
                ]
            },
            {
                name: "Ø§Ù„Ø£Ø­ÙŠØ§Ø¡", img: "https://files.coursatk.online/images/content/a47130a2b11a514a2dbb766013d8e9f24701aae245ee.jpg",
                teachers: [{ name: "Ø¯.Ø§Ø­Ù…Ø¯ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ", img: "https://files.coursatk.online/images/content/a47130a2b11a514a2dbb766013d8e9f24701aae245ee.jpg", chapters: [{chapter_name:"Ø§Ù„Ù…Ù†Ø§Ø¹Ø©", videos:[{name:"Ø§Ù„Ù…Ù†Ø§Ø¹Ø© ÙÙŠ Ø§Ù„Ù†Ø¨Ø§Øª", link:"https://river-5-558.rtbcdn.ru/hls-vod/bF_chMQsNTvg_V7-VbQCjg/1770501574/2646/0x5000039ce83a1935/810eac247fde4049b986dcc6a930358d.mp4.m3u8"}]}] }]
            },
            {
                name: "Ø§Ù„Ù„ØºØ§Øª Ø§Ù„Ø«Ø§Ù†ÙŠØ©", img: "https://cdn-icons-png.flaticon.com/512/3898/3898082.png",
                teachers: [{ name: "ÙØ±Ù†Ø³Ø§ÙˆÙŠ", img: "https://i.postimg.cc/NjRcy2s0/a75e136b-7909-485f-95e8-862fddd2c0bc.png", type:"yt", chapters:[{chapter_name:"ØªØ£Ø³ÙŠØ³", videos:[{name:"ØªØ£Ø³ÙŠØ³ 1", link:"3PC1fxpp-Xk"}]}] }]
            }
        ];

        // 2. Ø¯Ù…Ø¬ Ø§Ù„Ø¯Ø§ØªØ§ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ² (Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…)
        async function loadAndMerge() {
            try {
                const snap = await db.collection('new_videos').get();
                snap.forEach(doc => {
                    const v = doc.data();
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø§Ø¯Ø©
                    let sub = ALL_DATA.find(s => s.name === v.subject);
                    if(!sub) {
                        sub = { name: v.subject, img: v.subImg || "https://cdn-icons-png.flaticon.com/512/2997/2997380.png", teachers: [] };
                        ALL_DATA.push(sub);
                    }
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø¯Ø±Ø³
                    let teacher = sub.teachers.find(t => t.name === v.teacher);
                    if(!teacher) {
                        teacher = { name: v.teacher, img: v.techImg || "https://cdn-icons-png.flaticon.com/512/3135/3135715.png", chapters: [] };
                        sub.teachers.push(teacher);
                    }
                    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙˆØ±Ø³
                    let chapter = teacher.chapters.find(c => c.chapter_name === v.course);
                    if(!chapter) {
                        chapter = { chapter_name: v.course, videos: [] };
                        teacher.chapters.push(chapter);
                    }
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                    chapter.videos.push({ name: v.videoName, link: v.videoLink });
                });
                renderSubjects();
            } catch(e) {
                console.error("Error loading extra data", e);
                renderSubjects(); // Ø§Ø¹Ø±Ø¶ Ø§Ù„Ù„ÙŠ Ù…ÙˆØ¬ÙˆØ¯ ÙˆØ®Ù„Ø§Øµ
            }
        }

        // 3. Ø§Ù„Ø¹Ø±Ø¶
        const grid = document.getElementById('gridArea');
        const title = document.getElementById('pageTitle');
        const back = document.getElementById('backBtn');
        let viewStack = [];

        function createCard(title, img, onclick) {
            return `<div class="card" onclick="${onclick}">
                <img src="${img}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/2997/2997380.png'">
                <div class="card-title">${title}</div>
            </div>`;
        }

        function renderSubjects() {
            title.innerText = "Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©";
            back.style.display = 'none';
            viewStack = [{type: 'subjects'}];
            grid.className = 'grid';
            grid.innerHTML = ALL_DATA.map((sub, i) => createCard(sub.name, sub.img, `renderTeachers(${i})`)).join('');
        }

        window.renderTeachers = function(idx) {
            const sub = ALL_DATA[idx];
            title.innerText = sub.name;
            back.style.display = 'block';
            viewStack.push({type: 'teachers', idx});
            grid.innerHTML = sub.teachers.map((t, i) => createCard(t.name, t.img, `renderChapters(${idx}, ${i})`)).join('');
        };

        window.renderChapters = function(subIdx, teachIdx) {
            const teacher = ALL_DATA[subIdx].teachers[teachIdx];
            title.innerText = teacher.name;
            viewStack.push({type: 'chapters', subIdx, teachIdx});
            
            if(teacher.type === 'yt') { // Ù„Ùˆ Ù„ØºØ§Øª ØªØ§Ù†ÙŠØ© (ÙŠÙˆØªÙŠÙˆØ¨)
                 renderVideos(subIdx, teachIdx, 0); // Ø§Ø¹Ø±Ø¶ Ø§ÙˆÙ„ ÙØµÙ„ Ø¹Ù„Ø·ÙˆÙ„
                 return;
            }

            if(!teacher.chapters || teacher.chapters.length === 0) {
                grid.innerHTML = '<div style="text-align:center;width:100%;color:#777;margin-top:50px;">Ù‚Ø±ÙŠØ¨Ø§Ù‹</div>';
                return;
            }
            grid.innerHTML = teacher.chapters.map((c, i) => createCard(c.chapter_name, teacher.img, `renderVideos(${subIdx}, ${teachIdx}, ${i})`)).join('');
        };

        window.renderVideos = function(subIdx, teachIdx, chapIdx) {
            const teacher = ALL_DATA[subIdx].teachers[teachIdx];
            const chapter = teacher.chapters[chapIdx];
            title.innerText = chapter.chapter_name;
            viewStack.push({type: 'videos'});
            grid.className = 'video-list';
            
            const userCode = localStorage.getItem('fullmark_user');

            grid.innerHTML = chapter.videos.map((v, i) => `
                <div class="video-wrapper">
                    <div class="video-header">${v.name}</div>
                    <div class="plyr__video-embed">
                        ${v.link.includes('http') && !v.link.includes('youtu') ? 
                        `<video id="player-${i}" controls crossorigin playsinline style="width:100%"></video>` : 
                        `<iframe src="https://www.youtube.com/embed/${v.link}?origin=https://plyr.io&iv_load_policy=3&modestbranding=1&playsinline=1&showinfo=0&rel=0&enablejsapi=1" allowfullscreen allowtransparency allow="autoplay"></iframe>`
                        }
                        <div class="watermark">${userCode}</div>
                    </div>
                </div>`).join('');

            // ØªØ´ØºÙŠÙ„ HLS
            setTimeout(() => {
                chapter.videos.forEach((v, i) => {
                    if (v.link.includes('.m3u8')) {
                        const video = document.getElementById(`player-${i}`);
                        if (Hls.isSupported()) {
                            const hls = new Hls(); hls.loadSource(v.link); hls.attachMedia(video);
                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                            video.src = v.link;
                        }
                        new Plyr(video);
                    }
                });
            }, 500);
        };

        window.goBack = function() {
            if(viewStack.length > 1) {
                viewStack.pop();
                const prev = viewStack[viewStack.length - 1];
                if(prev.type === 'subjects') renderSubjects();
                else if(prev.type === 'teachers') renderTeachers(prev.idx);
                else if(prev.type === 'chapters') renderChapters(prev.subIdx, prev.teachIdx);
            }
        };

        function logout(){ localStorage.removeItem('fullmark_user'); window.location.href="login.html"; }

        if(!localStorage.getItem('fullmark_user')) window.location.href="login.html";
        
        loadAndMerge(); // ØªØ´ØºÙŠÙ„
    </script>
</body>
</html>
